# Chapter 2 â€” Mortgage Rate Gap & Shift-Share IV Construction

This folder contains scripts used to construct the monthly mortgage rate gap and
the shift-share (Bartik) instrumental variable for Chapter 2.

The pipeline proceeds sequentially from HMDA loan-level data and national interest
rate series to CBSA-by-month rate gap measures and IVs used in the empirical analysis.

All scripts assume that raw and intermediate data are organized according to the
repository structure under `data/raw/` and `data/transformed/`.

---

## Scripts

### 01_outstanding_rate_monthly.R

**Purpose**  
Construct a CBSA-by-month panel of outstanding-weighted mortgage rates using
loan-level HMDA data for 30-year fixed-rate mortgages.

**Main inputs**
- `data/transformed/ch02/hmda/hmda_30y_clean.csv`

**Main outputs**
- `data/transformed/ch02/rate_gap/msa_outstanding_rate_monthly.csv`

**Description**  
This script converts annual HMDA originations into a monthly stock of outstanding
mortgages by:
- assuming uniform origination across months,
- applying standard amortization schedules, and
- incorporating exponential decay to proxy for prepayment behavior.

The resulting CBSA-by-month outstanding mortgage rate is used as the local rate
component in the mortgage rate gap.

---

### 02_rate_gap_monthly.R

**Purpose**  
Merge the HMDA-based CBSA-by-month outstanding mortgage rate with national mortgage
rates from PMMS to construct the monthly mortgage rate gap, and produce a national
summary figure.

**Main inputs**
- `data/transformed/ch02/rate_gap/msa_outstanding_rate_monthly.csv`
- `data/raw/ch02/pmms/historicalweeklydata.xlsx`

**Main outputs**
- `data/transformed/ch02/rate_gap/pmms_30y_monthly.csv`
- `data/transformed/ch02/rate_gap/rate_gap_monthly.csv`
- `data/output/ch02/figures/fig_rate_gap_national_monthly.pdf`

**Description**  
This script:
1. Aggregates PMMS weekly 30-year fixed-rate mortgage data to monthly averages.
2. Merges PMMS monthly rates with the HMDA-based CBSA-month panel.
3. Computes the mortgage rate gap as the difference between national PMMS rates
   and local outstanding-weighted mortgage rates.
4. Produces a national monthly average rate gap figure for visualization.

---

### 03_build_shiftshare_iv.R

**Purpose**  
Construct a shift-share (Bartik) instrumental variable combining local mortgage-rate
exposure with national mortgage rate shocks.

**Main inputs**
- `data/raw/ch02/pmms/historicalweeklydata.xlsx`
- `data/raw/ch02/gs10/GS10.csv`
- `data/transformed/ch02/hmda/hmda_30y_clean.csv`

**Main outputs**
- `data/transformed/ch02/rate_gap/ss_iv.csv`

**Description**  
This script constructs the shift-share IV in three steps:
1. **National shock (NatShock):** Monthly residuals from regressing PMMS 30-year
   mortgage rates on the 10-year Treasury yield (GS10).
2. **Local exposure (Exposure):** A CBSA-level index constructed from HMDA loan-level
   interest-rate distributions using PCA, with optional half-life decay over the
   exposure window.
3. **Shift-share IV:** The interaction of Exposure and NatShock, producing a
   CBSA-by-month Bartik-style instrument.

The resulting IV is used in the causal analysis of mortgage rate lock-in effects.

---

## Execution order

Scripts should be run in the following order:

1. `01_outstanding_rate_monthly.R`
2. `02_rate_gap_monthly.R`
3. `03_build_shiftshare_iv.R`

Each script depends on outputs generated by the previous steps.
